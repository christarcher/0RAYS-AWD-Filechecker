# .github/workflows/release.yml
name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ v1.0.0, v1.1.0 ç­‰æ ‡ç­¾æ—¶è§¦å‘

jobs:
  build:
    name: Build and Release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.19'
        
    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
    - name: Build binaries
      run: |
        # åˆ›å»ºdistç›®å½•
        mkdir -p dist
        
        # æ„å»º Linux AMD64
        echo "Building for Linux AMD64..."
        GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o dist/awd-filechecker-linux-amd64 awd-filechecker.go
        
        # æ„å»º Linux ARM64
        echo "Building for Linux ARM64..."
        GOOS=linux GOARCH=arm64 go build -ldflags="-s -w" -o dist/awd-filechecker-linux-arm64 awd-filechecker.go
        
        # éªŒè¯æ„å»ºçš„æ–‡ä»¶
        ls -la dist/
        file dist/*
        
    - name: Create release packages
      run: |
        cd dist
        
        # åˆ›å»º Linux AMD64 å‘å¸ƒåŒ…
        mkdir -p amd64-package
        cp awd-filechecker-linux-amd64 amd64-package/awd-filechecker
        cp ../notifier.py amd64-package/
        cp ../requirements.txt amd64-package/
        cp ../README.md amd64-package/
        cp ../LICENSE amd64-package/

        tar -czf 0rays-edr-filechecker-${{ steps.get_version.outputs.VERSION }}-linux-amd64.tar.gz -C amd64-package .
        
        # åˆ›å»º Linux ARM64 å‘å¸ƒåŒ…
        mkdir -p arm64-package
        cp awd-filechecker-linux-arm64 arm64-package/awd-filechecker
        cp ../notifier.py arm64-package/
        cp ../requirements.txt arm64-package/
        cp ../README.md arm64-package/
        cp ../LICENSE arm64-package/
        cp amd64-package/INSTALL.txt arm64-package/
        
        tar -czf 0rays-edr-filechecker-${{ steps.get_version.outputs.VERSION }}-linux-arm64.tar.gz -C arm64-package .
        
        # æ˜¾ç¤ºæœ€ç»ˆæ–‡ä»¶
        ls -la *.tar.gz
        
    - name: Generate checksums
      run: |
        cd dist
        sha256sum *.tar.gz > checksums.txt
        cat checksums.txt
        
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_version.outputs.VERSION }}
        release_name: 0RAYS EDR File Checker ${{ steps.get_version.outputs.VERSION }}
        body: |
          ## 0RAYS EDR File Checker ${{ steps.get_version.outputs.VERSION }}
          
          ### ä¸‹è½½è¯´æ˜
          
          **Linux AMD64** (é€‚ç”¨äºå¤§å¤šæ•°LinuxæœåŠ¡å™¨):
          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.VERSION }}/0rays-edr-filechecker-${{ steps.get_version.outputs.VERSION }}-linux-amd64.tar.gz
          tar -xzf 0rays-edr-filechecker-${{ steps.get_version.outputs.VERSION }}-linux-amd64.tar.gz
          chmod +x awd-filechecker
          ```
          
          **Linux ARM64** (é€‚ç”¨äºARMæ¶æ„æœåŠ¡å™¨ï¼Œå¦‚æ ‘è“æ´¾):
          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.VERSION }}/0rays-edr-filechecker-${{ steps.get_version.outputs.VERSION }}-linux-arm64.tar.gz
          tar -xzf 0rays-edr-filechecker-${{ steps.get_version.outputs.VERSION }}-linux-arm64.tar.gz
          chmod +x awd-filechecker
          ```
          
          ### ğŸš€ å¿«é€Ÿå¼€å§‹
          
          1. **åŸºæœ¬ç›‘æ§:**
             ```bash
             ./awd-filechecker -m /var/www/html -b /tmp/edr
             ```
          
          2. **å¯ç”¨æ¡Œé¢é€šçŸ¥:**
             ```bash
             # ç»ˆç«¯1: å¯åŠ¨é€šçŸ¥å™¨
             pip3 install -r requirements.txt
             python3 notifier.py
             
             # ç»ˆç«¯2: å¯åŠ¨ç›‘æ§
             ./awd-filechecker -m /var/www/html -b /tmp/edr -a 127.0.0.1:8080
             ```
          
          3. **WebæœåŠ¡å™¨é˜²æŠ¤:**
             ```bash
             ./awd-filechecker -m /var/www/html -b /opt/edr-backup -e .php,.jsp,.asp
             ```
          
          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          - Linux ç³»ç»Ÿ (ä¸æ”¯æŒ Windows/macOS)
          - Go 1.19+ (å¦‚éœ€ç¼–è¯‘)
          - Python 3.7+ (é€šçŸ¥å™¨å¯é€‰)
          
          
          ---
          
          **å®Œæ•´æ›´æ–°æ—¥å¿—è¯·æŸ¥çœ‹:** [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/${{ steps.get_version.outputs.VERSION }}/CHANGELOG.md)
        draft: false
        prerelease: false
        
    - name: Upload AMD64 Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./dist/0rays-edr-filechecker-${{ steps.get_version.outputs.VERSION }}-linux-amd64.tar.gz
        asset_name: 0rays-edr-filechecker-${{ steps.get_version.outputs.VERSION }}-linux-amd64.tar.gz
        asset_content_type: application/gzip
        
    - name: Upload ARM64 Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./dist/0rays-edr-filechecker-${{ steps.get_version.outputs.VERSION }}-linux-arm64.tar.gz
        asset_name: 0rays-edr-filechecker-${{ steps.get_version.outputs.VERSION }}-linux-arm64.tar.gz
        asset_content_type: application/gzip
        
    - name: Upload Checksums
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./dist/checksums.txt
        asset_name: checksums.txt
        asset_content_type: text/plain
